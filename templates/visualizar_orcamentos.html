{% extends "base.html" %}

{% block content %}
<h2>Or√ßamento para {{ cliente }}
    <button onclick="abrirModal()" 
        title="Visualizar or√ßamento completo" 
        style="margin-left:10px; font-size: 1.5em; cursor:pointer; border:none; background:none;">
        üëÅÔ∏è
    </button>
</h2>
<p>Data: {{ data }}</p>

<h3>Produtos</h3>
<ul>
    {% for produto in produtos_selecionados %}
    <li id="produto_{{ produto.codigo }}">
        {{ produto.nome }} - {{ produto.quantidade }} x R$ {{ "%.2f"|format(produto.preco_unitario) }} = R$ {{ "%.2f"|format(produto.total) }}
        <button type="button" class="btn-excluir" onclick="removerItem('produto_{{ produto.codigo }}')" title="Remover produto">
            üóëÔ∏è
        </button>
    </li>
    {% else %}
    <li>Nenhum produto selecionado</li>
    {% endfor %}
</ul>

<h3>Servi√ßos</h3>
<ul>
    {% for servico in servicos_selecionados %}
    <li id="servico_{{ servico.codigo }}">
        {{ servico.nome }} - {{ servico.quantidade }} x R$ {{ "%.2f"|format(servico.preco_unitario) }} = R$ {{ "%.2f"|format(servico.total) }}
        <button type="button" class="btn-excluir" onclick="removerItem('servico_{{ servico.codigo }}')" title="Remover servi√ßo">
            üóëÔ∏è
        </button>
    </li>
    {% else %}
    <li>Nenhum servi√ßo selecionado</li>
    {% endfor %}
</ul>

<h3>Resumo Financeiro</h3>
<p>Subtotal: R$ {{ "%.2f"|format(subtotal) }}</p>

{% if taxa_cartao and taxa_cartao > 0 %}
<p>Taxa de cart√£o ({{ parcelas }}x): R$ {{ "%.2f"|format(taxa_cartao) }}</p>
{% endif %}

<p><strong>TOTAL: R$ {{ "%.2f"|format(total) }}</strong></p>

<p>Forma de pagamento: {{ forma_pagamento|capitalize }}</p>

{% if forma_pagamento == "cartao" and parcelas and parcelas > 1 %}
<p>Parcelado em {{ parcelas }}x de R$ {{ "%.2f"|format(total / parcelas) }}</p>
{% endif %}

<p>Validade: {{ validade }}</p>

<form method="POST" action="{{ url_for('gerar_orcamento') }}">
    {% for produto in produtos_selecionados %}
    <input type="hidden" name="produto_{{ produto.codigo }}_quantidade" value="{{ produto.quantidade }}">
    {% endfor %}
    {% for servico in servicos_selecionados %}
    <input type="hidden" name="servico_{{ servico.codigo }}_quantidade" value="{{ servico.quantidade }}">
    {% endfor %}
    <input type="hidden" name="cliente" value="{{ cliente }}">
    <input type="hidden" name="forma_pagamento" value="{{ forma_pagamento }}">
    <input type="hidden" name="parcelas" value="{{ parcelas }}">
    <button type="submit" name="gerar_pdf">Gerar PDF</button>
</form>

<!-- Modal para or√ßamento completo -->
<div id="modalOrcamento" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:#fff; max-width:800px; margin:50px auto; padding:20px; border-radius:8px; position:relative; height:80vh; overflow-y:auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <button onclick="fecharModal()" 
            style="position:absolute; top:10px; right:10px; font-size:1.5em; border:none; background:none; cursor:pointer;" 
            title="Fechar modal">‚úñÔ∏è
        </button>
        
        <h3>Or√ßamento Completo - {{ cliente }}</h3>
        <p><strong>Data:</strong> {{ data }}</p>

        <h4>Produtos</h4>
        <ul>
            {% for produto in produtos_selecionados %}
            <li>{{ produto.nome }} - {{ produto.quantidade }} x R$ {{ "%.2f"|format(produto.preco_unitario) }} = R$ {{ "%.2f"|format(produto.total) }}</li>
            {% else %}
            <li>Nenhum produto selecionado</li>
            {% endfor %}
        </ul>
        
        <h4>Servi√ßos</h4>
        <ul>
            {% for servico in servicos_selecionados %}
            <li>{{ servico.nome }} - {{ servico.quantidade }} x R$ {{ "%.2f"|format(servico.preco_unitario) }} = R$ {{ "%.2f"|format(servico.total) }}</li>
            {% else %}
            <li>Nenhum servi√ßo selecionado</li>
            {% endfor %}
        </ul>

        <h4>Resumo Financeiro</h4>
        <p>Subtotal: R$ {{ "%.2f"|format(subtotal) }}</p>
        {% if taxa_cartao and taxa_cartao > 0 %}
        <p>Taxa de cart√£o ({{ parcelas }}x): R$ {{ "%.2f"|format(taxa_cartao) }}</p>
        {% endif %}
        <p><strong>TOTAL: R$ {{ "%.2f"|format(total) }}</strong></p>
        <p>Forma de pagamento: {{ forma_pagamento|capitalize }}</p>
        {% if forma_pagamento == "cartao" and parcelas and parcelas > 1 %}
        <p>Parcelado em {{ parcelas }}x de R$ {{ "%.2f"|format(total / parcelas) }}</p>
        {% endif %}
        <p>Validade: {{ validade }}</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function removerItem(itemId) {
        const item = document.getElementById(itemId);
        if (item) {
            item.remove();
            // Pode implementar atualiza√ß√£o de valores aqui
        }
    }

    function abrirModal() {
        document.getElementById('modalOrcamento').style.display = 'block';
        // Impede scroll atr√°s do modal
        document.body.style.overflow = 'hidden';
    }

    function fecharModal() {
        document.getElementById('modalOrcamento').style.display = 'none';
        // Restaura scroll da p√°gina
        document.body.style.overflow = 'auto';
    }

    // Fecha o modal ao clicar fora da caixa branca
    window.onclick = function(event) {
        const modal = document.getElementById('modalOrcamento');
        if (event.target === modal) {
            fecharModal();
        }
    }
</script>
{% endblock %}
