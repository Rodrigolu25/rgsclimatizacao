{% extends "base.html" %}

{% block title %}Lista de Or√ßamentos{% endblock %}

{% block content %}
<div class="card">
    <h2>Or√ßamentos Realizados</h2>
    
    {% if orcamentos %}
    <table>
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Servi√ßo</th>
                <th>Valor Base</th>
                <th>Taxa Cart√£o</th>
                <th>Total</th>
                <th>Observa√ß√µes</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for orcamento in orcamentos %}
            <tr id="orcamento_{{ loop.index }}">
                <td>{{ orcamento.cliente }}</td>
                <td>{{ orcamento.servico }}</td>
                <td>R$ {{ "{:.2f}".format(orcamento.valor_base) }}</td>
                <td>{{ "{:.1f}".format(orcamento.taxa_cartao) }}%</td>
                <td>R$ {{ "{:.2f}".format(orcamento.valor_total) }}</td>
                <td>{{ orcamento.observacoes or '-' }}</td>
                <td>
                    <!-- Bot√£o para visualizar -->
                    <button type="button" 
                        onclick="abrirModal({{ loop.index0 }})" 
                        title="Visualizar or√ßamento completo" 
                        style="font-size:1.2em; cursor:pointer; border:none; background:none; margin-right: 6px;">
                        üëÅÔ∏è
                    </button>

                    <!-- Bot√£o para editar -->
                    <a href="{{ url_for('editar_orcamento', index=loop.index0) }}" 
                       title="Editar or√ßamento" 
                       style="font-size:1.2em; cursor:pointer; text-decoration:none; margin-right: 6px;">
                        ‚úèÔ∏è
                    </a>

                    <!-- Bot√£o para gerar/baixar PDF -->
                    <a href="{{ url_for('gerar_pdf', index=loop.index0) }}" 
                       title="Baixar or√ßamento em PDF" 
                       style="font-size:1.2em; cursor:pointer; text-decoration:none; margin-right: 6px;">
                        üìÑ
                    </a>

                    <!-- Bot√£o para excluir -->
                    <button type="button" class="btn-excluir" 
                        onclick="removerOrcamento({{ loop.index0 }}, 'orcamento_{{ loop.index }}')" 
                        title="Excluir or√ßamento"
                        style="font-size:1.2em; cursor:pointer; border:none; background:none;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px; text-align: right;">
        <p id="total-geral" class="total-value">
            Total Geral: R$ {{ "{:.2f}".format(orcamentos|sum(attribute='valor_total')) }}
        </p>
    </div>
    {% else %}
    <p>Nenhum or√ßamento cadastrado ainda.</p>
    {% endif %}
</div>

<!-- Modal para mostrar or√ßamento completo -->
<div id="modalOrcamento" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:#fff; max-width:700px; margin:50px auto; padding:20px; border-radius:8px; position:relative; max-height:80vh; overflow-y:auto;">
        <button onclick="fecharModal()" 
            style="position:absolute; top:10px; right:10px; font-size:1.5em; border:none; background:none; cursor:pointer;" 
            title="Fechar modal">‚úñÔ∏è
        </button>
        <h3>Detalhes do Or√ßamento</h3>
        <div id="detalhesOrcamento">
            <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const orcamentosData = {{ orcamentos|tojson }};

    function removerOrcamento(index, rowId) {
        if (confirm('Tem certeza que deseja excluir este or√ßamento?')) {
            fetch(`/excluir_orcamento/${index}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const linha = document.getElementById(rowId);
                    if (linha) {
                        linha.remove();
                        atualizarTotalGeral();
                    }
                } else {
                    alert("Erro ao excluir: " + data.message);
                }
            })
            .catch(err => {
                alert("Erro ao excluir: " + err);
            });
        }
    }

    function atualizarTotalGeral() {
        let total = 0.0;
        const rows = document.querySelectorAll("tbody tr");
        rows.forEach(row => {
            const valorTexto = row.cells[4].textContent
                .replace("R$", "")
                .replace(",", ".")
                .trim();
            const valor = parseFloat(valorTexto);
            if (!isNaN(valor)) {
                total += valor;
            }
        });

        const totalEl = document.getElementById("total-geral");
        if (totalEl) {
            totalEl.textContent = "Total Geral: R$ " + total.toFixed(2);
        }
    }

    function abrirModal(index) {
        const orcamento = orcamentosData[index];
        if (!orcamento) return;

        // Montar o conte√∫do do modal com detalhes
        const detalhes = `
            <p><strong>Cliente:</strong> ${orcamento.cliente}</p>
            <p><strong>Servi√ßo:</strong> ${orcamento.servico}</p>
            <p><strong>Valor Base:</strong> R$ ${orcamento.valor_base.toFixed(2)}</p>
            <p><strong>Taxa Cart√£o:</strong> ${orcamento.taxa_cartao.toFixed(1)}%</p>
            <p><strong>Valor Total:</strong> R$ ${orcamento.valor_total.toFixed(2)}</p>
            <p><strong>Observa√ß√µes:</strong> ${orcamento.observacoes || '-'}</p>
        `;

        document.getElementById('detalhesOrcamento').innerHTML = detalhes;
        document.getElementById('modalOrcamento').style.display = 'block';
        document.body.style.overflow = 'hidden'; // Bloquear scroll atr√°s do modal
    }

    function fecharModal() {
        document.getElementById('modalOrcamento').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Fechar modal clicando fora da caixa branca
    window.onclick = function(event) {
        const modal = document.getElementById('modalOrcamento');
        if (event.target === modal) {
            fecharModal();
        }
    }
</script>
{% endblock %}
